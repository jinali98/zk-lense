name: Release

on:
    push:
        tags:
            - "v*"

jobs:
    build:
        name: Build for ${{ matrix.target }}
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                      archive: tar.gz
                      bin-name: zklense
                    - os: macos-latest
                      target: x86_64-apple-darwin
                      archive: tar.gz
                      bin-name: zklense
                    - os: macos-latest
                      target: aarch64-apple-darwin
                      archive: tar.gz
                      bin-name: zklense
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc
                      archive: zip
                      bin-name: zklense.exe

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Install cross (for cross-compilation)
              if: matrix.os == 'ubuntu-latest'
              run: cargo install cross --git https://github.com/cross-rs/cross

            - name: Build release binary
              working-directory: cli
              shell: bash
              run: |
                  if [ "${{ matrix.os }}" == "ubuntu-latest" ] && [ "${{ matrix.target }}" != "x86_64-unknown-linux-gnu" ]; then
                    cross build --release --target ${{ matrix.target }}
                  else
                    cargo build --release --target ${{ matrix.target }}
                  fi

            - name: Create archive
              shell: bash
              run: |
                  cd cli/target/${{ matrix.target }}/release
                  if [ "${{ matrix.archive }}" == "tar.gz" ]; then
                    tar czf $GITHUB_WORKSPACE/zklense-${{ matrix.target }}.${{ matrix.archive }} ${{ matrix.bin-name }}
                  else
                    7z a $GITHUB_WORKSPACE/zklense-${{ matrix.target }}.${{ matrix.archive }} ${{ matrix.bin-name }}
                  fi

            - name: Generate checksum
              shell: bash
              run: |
                  if [ "${{ matrix.os }}" == "windows-latest" ]; then
                    certutil -hashfile zklense-${{ matrix.target }}.${{ matrix.archive }} SHA256 > zklense-${{ matrix.target }}.${{ matrix.archive }}.sha256
                  else
                    shasum -a 256 zklense-${{ matrix.target }}.${{ matrix.archive }} > zklense-${{ matrix.target }}.${{ matrix.archive }}.sha256
                  fi

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.target }}
                  path: |
                      zklense-${{ matrix.target }}.${{ matrix.archive }}
                      zklense-${{ matrix.target }}.${{ matrix.archive }}.sha256

    release:
        name: Create Release
        needs: build
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Prepare release assets
              shell: bash
              run: |
                  mkdir -p release-assets
                  find artifacts -name "*.tar.gz" -o -name "*.zip" | xargs -I {} cp {} release-assets/
                  find artifacts -name "*.sha256" | xargs -I {} cp {} release-assets/

                  # Create combined checksums file
                  cat release-assets/*.sha256 > release-assets/checksums.txt

            - name: Extract version from tag
              id: get_version
              run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  files: release-assets/*
                  name: Release ${{ steps.get_version.outputs.VERSION }}
                  body: |
                      ## Release ${{ steps.get_version.outputs.VERSION }}

                      ### Installation

                      Download the binary for your platform:

                      - **Linux (x86_64)**: `zklense-x86_64-unknown-linux-gnu.tar.gz`
                      - **macOS (Intel)**: `zklense-x86_64-apple-darwin.tar.gz`
                      - **macOS (Apple Silicon)**: `zklense-aarch64-apple-darwin.tar.gz`
                      - **Windows**: `zklense-x86_64-pc-windows-msvc.zip`

                      See [INSTALL.md](https://github.com/${{ github.repository }}/blob/master/INSTALL.md) for detailed installation instructions.

                      ### Verify Checksums

                      All releases include SHA256 checksums. Verify your download:

                      ```bash
                      sha256sum -c checksums.txt
                      ```
                  draft: false
                  prerelease: false
